const Joi=require('joi');const todoService=require('../services/todoService');
exports.list=async(req,res,next)=>{try{const{status='all',priority,q,page=1,limit=10}=req.query;const f={};if(req.user.role!=='admin')f.user=req.user.id;if(status==='active')f.completed=false;if(status==='completed')f.completed=true;if(priority)f.priority=priority;if(q)f.title={$regex:q,$options:'i'};const{todos,total}=await todoService.findTodos(f,{page:Number(page),limit:Number(limit)});res.json({data:todos,meta:{total,page:Number(page),limit:Number(limit),pages:Math.ceil(total/limit)}});}catch(e){next(e);}};
exports.create=async(req,res,next)=>{try{const s=Joi.object({title:Joi.string().required(),priority:Joi.string().valid('low','medium','high'),dueDate:Joi.date()});const{error,v}=s.validate(req.body);if(error)return res.status(400).json({message:error.details[0].message});const todo=await todoService.createTodo({...v,user:req.user.id});res.status(201).json(todo);}catch(e){next(e);}};
exports.getById=async(req,res,next)=>{try{const t=await todoService.findTodoById(req.params.id);if(!t)return res.status(404).json({message:'Not found'});if(req.user.role!=='admin'&&String(t.user)!==req.user.id)return res.status(403).json({message:'Forbidden'});res.json(t);}catch(e){next(e);}};
exports.update=async(req,res,next)=>{try{const s=Joi.object({title:Joi.string(),completed:Joi.boolean(),priority:Joi.string().valid('low','medium','high'),dueDate:Joi.date()});const{error,v}=s.validate(req.body);if(error)return res.status(400).json({message:error.details[0].message});const t=await todoService.findTodoById(req.params.id);if(!t)return res.status(404).json({message:'Not found'});if(req.user.role!=='admin'&&String(t.user)!==req.user.id)return res.status(403).json({message:'Forbidden'});res.json(await todoService.updateTodo(t,v));}catch(e){next(e);}};
exports.remove=async(req,res,next)=>{try{const t=await todoService.findTodoById(req.params.id);if(!t)return res.status(404).json({message:'Not found'});await todoService.deleteTodo(t);res.status(204).send();}catch(e){next(e);}};
exports.toggle=async(req,res,next)=>{try{const t=await todoService.findTodoById(req.params.id);if(!t)return res.status(404).json({message:'Not found'});if(req.user.role!=='admin'&&String(t.user)!==req.user.id)return res.status(403).json({message:'Forbidden'});res.json(await todoService.updateTodo(t,{completed:!t.completed}));}catch(e){next(e);}};
